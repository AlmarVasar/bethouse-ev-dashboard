<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BetHouse EV Dashboard</title>
    <style>
        body {
            margin: 0;
            font-family: Inter, Roboto, sans-serif;
            background: radial-gradient(circle at top, #1c1f26, #0f1116);
            color: #eaeaf0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            background: #161922;
            width: 480px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.5);
        }

        h1 { margin:0 0 8px 0; font-size: 26px; }
        .subtitle { font-size:13px; color:#8b90a0; margin-bottom:24px; }
        label { font-size:12px; color:#9aa0b4; margin-bottom:6px; display:block; }
        input, select {
            width:100%; padding:10px 12px; margin-bottom:16px;
            border-radius:10px; border:1px solid #2a2e3a;
            background:#0f1116; color:#fff; outline:none;
        }
        input:focus, select:focus { border-color:#5c7cfa; }
        button {
            width:100%; padding:12px; border-radius:12px; border:none;
            background: linear-gradient(135deg, #5c7cfa, #4dabf7);
            color:#fff; font-size:15px; font-weight:600;
            cursor:pointer; transition:0.15s ease;
        }
        button:hover { transform:translateY(-1px); box-shadow:0 10px 30px rgba(92,124,250,0.4); }

        .result {
            margin-top:24px; padding:20px; border-radius:16px; background:#0f1116;
            border:1px solid #2a2e3a; display:none;
        }
        .result h3 { margin:0 0 12px 0; font-size:14px; letter-spacing:0.6px; }
        .row { display:flex; justify-content:space-between; font-size:13px; margin-bottom:8px; }
        .positive { color:#4ade80; }
        .negative { color:#f87171; }
        .muted { color:#8b90a0; }
        .decision { margin-top:12px; padding-top:12px; border-top:1px solid #2a2e3a;
            font-size:15px; font-weight:600; text-align:center; }

        .ev-bar-container {
            height:20px; background:#2a2e3a; border-radius:12px;
            overflow:hidden; margin-top:12px; margin-bottom:12px;
        }
        .ev-bar {
            height:100%; width:0%; border-radius:12px;
            transition: width 0.5s ease, background 0.5s ease;
        }

        input[type="range"] {
            width:100%;
            margin-top:8px;
            -webkit-appearance:none;
            height:6px; background:#2a2e3a; border-radius:6px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance:none; width:18px; height:18px; border-radius:50%;
            background:#5c7cfa; cursor:pointer;
        }
    </style>
</head>
<body>

<div class="card">
    <h1>BetHouse EV Dashboard</h1>
    <div class="subtitle">Sharp · Audit-Protected · Deterministic</div>

    <!-- ================= FAIR ODDS + EV SECTION ================= -->
    <h2>Fair Odds Calculator (NO-VIG)</h2>
    <label>Sharp Over Odds *</label>
    <input id="sharpOver" type="number" step="0.01" placeholder="e.g. 1.95" required>

    <label>Sharp Under Odds *</label>
    <input id="sharpUnder" type="number" step="0.01" placeholder="e.g. 1.85" required>

    <label>Soft Odds *</label>
    <input id="softOdds" type="number" step="0.01" placeholder="e.g. 2.05" required>

    <label>Bankroll</label>
    <input id="bankroll2" type="number" value="1000">

    <label>Market Type</label>
    <select id="marketType2">
        <option value="FULL_TIME">Full Time</option>
        <option value="FIRST_HALF">1st Half</option>
    </select>

    <button onclick="calculateFairEV()">Calculate Fair & EV</button>

    <div id="fairResult" class="result"></div>

    <!-- ================= ORIGINAL EV DASHBOARD SECTION ================= -->
    <h2>Original EV Dashboard</h2>
    <label>Sharp Price</label>
    <input id="sharp" type="number" step="0.01" placeholder="e.g. 1.95">

    <label>Soft Price</label>
    <input id="soft" type="number" step="0.01" placeholder="e.g. 2.10">

    <label>Bankroll</label>
    <input id="bankroll" type="number" value="1000">

    <label>Market</label>
    <select id="market">
        <option value="FULL_TIME">Full Time</option>
        <option value="FIRST_HALF">1st Half</option>
    </select>

    <button onclick="calculateOriginalEV()">Calculate EV</button>

    <div id="result" class="result">
        <h3>ANALYSIS RESULT</h3>
        <div class="row"><span class="muted">FAIR RANGE</span> <span id="fairRange">-</span></div>
        <div class="row"><span class="muted">EV</span> <span id="evValue">-</span></div>
        <div class="ev-bar-container">
            <div id="evBar" class="ev-bar"></div>
        </div>
        <div class="row"><span class="muted">STAKE</span> <span id="stakeValue">-</span></div>
        <div class="row"><span class="muted">AUDIT</span> <span id="auditStatus">-</span></div>
        <div class="decision" id="decisionText">-</div>
        <div class="polymarket" id="polymarketText">-</div>
        <label>Adjust Stake</label>
        <input id="stakeSlider" type="range" min="0" max="100" value="0" step="1">
    </div>
</div>

<script>
    /* ================= FAIR ODDS + EV LOGIC ================= */
    function calculateFairEV() {
        const sharpOver = parseFloat(document.getElementById('sharpOver').value);
        const sharpUnder = parseFloat(document.getElementById('sharpUnder').value);
        const softOdds = parseFloat(document.getElementById('softOdds').value);
        const bankroll = parseFloat(document.getElementById('bankroll2').value);
        const market = document.getElementById('marketType2').value;
        const resultBox = document.getElementById('fairResult');

        if (!sharpOver || !sharpUnder || !softOdds) {
            resultBox.innerHTML = '<div class="negative">Please fill in all required fields (*)</div>';
            resultBox.style.display = 'block';
            return;
        }

        const pOverRaw = 1.0 / sharpOver;
        const pUnderRaw = 1.0 / sharpUnder;
        const vigSum = pOverRaw + pUnderRaw;
        const pOverFair = pOverRaw / vigSum;
        const pUnderFair = pUnderRaw / vigSum;

        if (Math.abs(pOverFair + pUnderFair - 1.0) > 1e-6) {
            resultBox.innerHTML = '<div class="negative">Error: NO-VIG normalization failed</div>';
            return;
        }

        const fairOver = 1.0 / pOverFair;
        const fairUnder = 1.0 / pUnderFair;
        const fairLow = Math.min(fairOver, fairUnder);
        const fairHigh = Math.max(fairOver, fairUnder);

        const selectedFair = fairLow; // choose strategy
        let ev = (softOdds / selectedFair) - 1.0;

        if ((softOdds > selectedFair && ev <= 0) || (softOdds < selectedFair && ev >= 0)) {
            resultBox.innerHTML = '<div class="negative">EV Audit Failed: Soft odds violate rules</div>';
            return;
        }

        resultBox.innerHTML = `
        <h3>Fair Odds Result</h3>
        <div class="row"><span class="muted">FAIR RANGE</span> <span>${fairLow.toFixed(2)} – ${fairHigh.toFixed(2)}</span></div>
        <div class="row"><span class="muted">EV</span> <span class="${ev>0?'positive':'negative'}">${(ev*100).toFixed(2)}%</span></div>
        <div class="row"><span class="muted">Bankroll</span> <span>€${bankroll.toFixed(2)}</span></div>
        <div class="row"><span class="muted">Market</span> <span>${market}</span></div>
        <div class="decision ${ev>0?'positive':'negative'}">${ev>0?'BET APPROVED':'NO BET'}</div>
    `;
        resultBox.style.display = 'block';
    }

    /* ================= ORIGINAL EV DASHBOARD LOGIC ================= */
    function calculateOriginalEV() {
        const sharpInput = document.getElementById('sharp').value;
        const softInput = document.getElementById('soft').value;
        const bankrollInput = document.getElementById('bankroll').value;
        const marketInput = document.getElementById('market').value;
        const resultBox = document.getElementById('result');

        resultBox.style.display = "block";

        if (!sharpInput || isNaN(sharpInput) || parseFloat(sharpInput) <= 0) {
            resultBox.innerHTML = '<div class="negative">Please enter a valid Sharp Price</div>';
            return;
        }
        if (!bankrollInput || isNaN(bankrollInput) || parseFloat(bankrollInput) <= 0) {
            resultBox.innerHTML = '<div class="negative">Please enter a valid Bankroll</div>';
            return;
        }

        resultBox.innerHTML = "<span class='muted'>Calculating…</span>";

        fetch('/api/calculate', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                sharpPrice: parseFloat(sharpInput),
                softPrice: softInput ? parseFloat(softInput): null,
                bankroll: parseFloat(bankrollInput),
                marketType: marketInput
            })
        })
            .then(async r=>{
                const data=await r.json();
                if(!r.ok) throw data;
                return data;
            })
            .then(data=>{
                const evPct = (data.ev*100).toFixed(2);
                const positive = data.ev>0;

                document.getElementById('fairRange').textContent = `${data.fair.low.toFixed(2)} – ${data.fair.high.toFixed(2)}`;
                document.getElementById('evValue').textContent = (positive ? '+' : '') + evPct + '%';
                document.getElementById('evValue').className = positive ? 'positive' : 'negative';
                document.getElementById('stakeValue').textContent = `€${data.stake.toFixed(2)}`;
                document.getElementById('auditStatus').textContent = data.auditStatus;
                document.getElementById('decisionText').textContent = positive ? 'BET APPROVED' : 'NO BET';
                document.getElementById('decisionText').className = 'decision ' + (positive ? 'positive' : 'negative');

                const bar = document.getElementById('evBar');
                bar.style.width = Math.min(Math.abs(evPct),100)+'%';
                bar.style.background = positive ? '#4ade80' : '#f87171';

                const poly = document.getElementById('polymarketText');
                if(data.ev>0 && data.fair.high - data.sharpPrice >=0.02) poly.textContent='Polymarket: Consider BUY';
                else if(data.ev<0 && data.sharpPrice - data.fair.low >=0.02) poly.textContent='Polymarket: Consider SELL';
                else poly.textContent='Polymarket: No Trade';

                const slider = document.getElementById('stakeSlider');
                slider.max = data.stake.toFixed(2);
                slider.value = data.stake.toFixed(2);
                slider.addEventListener('input', ()=> document.getElementById('stakeValue').textContent=`€${slider.value}`);
            })
            .catch(err=>{
                resultBox.innerHTML = `
            <h3>ANALYSIS STOPPED</h3>
            <div class="negative">${err.message || 'Rule violation detected'}</div>
        `;
            });
    }
</script>
</body>
</html>
